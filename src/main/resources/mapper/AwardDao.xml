<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.al.o2o.dao.AwardDao">

    <resultMap id="awardMap" type="com.al.o2o.entity.Award">
        <!-- 定义主键ID -->
        <id column="award_id" property="awardId"/>
        <result column="award_name" property="awardName"/>
        <result column="award_desc" property="awardDesc"/>
        <result column="award_img" property="awardImg"/>
        <result column="point" property="point"/>
        <result column="priority" property="priority"/>
        <result column="create_time" property="createTime"/>
        <result column="last_edit_time" property="lastEditTime"/>
        <!-- 定义复合类型 -->
        <association property="shop" column="shop_id" javaType="com.al.o2o.entity.Shop">
            <id column="shop_id" property="shopId"/>
            <result column="shop_name" property="shopName"/>
        </association>
    </resultMap>

    <!-- 分页查询奖品信息 -->
    <select id="queryAwardList" resultMap="awardMap">
        SELECT
        a.award_id,a.award_name,a.award_desc,a.award_img,
        a.point,a.priority,a.create_time,a.last_edit_time,a.enable_status,
        s.shop_id,s.shop_name
        FROM
        tb_award a ,
        tb_shop s
        <where>
            <if test="awardCondition.shop !=null
            and awardCondition.shop.shopId !=null ">
                and a.shop_id = #{awardCondition.shop.shopId}
            </if>
            <if test="awardCondition.awardName != null">
                and a.award_name like '%${awardCondition.awardName}%'
            </if>
            <if test="awardCondition.enableStatus != null">
                and a.enable_status = #{awardCondition.enableStatus}
            </if>
            AND
            a.shop_id = s.shop_id
        </where>
        ORDER BY
        a.priority DESC
        LIMIT #{rowIndex},#{pageSize};
    </select>

    <!-- 查询总数 -->
    <select id="queryAwardCount" resultType="int">
        SELECT COUNT(1)
        FROM tb_award a , tb_shop s
        <where>
            <if test="awardCondition.shop !=null
            and awardCondition.shop.shopId !=null ">
                and a.shop_id = #{awardCondition.shop.shopId}
            </if>
            <if test="awardCondition.awardName != null">
                and a.award_name like '%${awardCondition.awardName}%'
            </if>
            <if test="awardCondition.enableStatus != null">
                and a.enable_status = #{awardCondition.enableStatus}
            </if>
            AND
            a.shop_id = s.shop_id
        </where>
    </select>

    <!-- 查询奖品信息 -->
    <select id="queryAwardByAwardId" resultMap="awardMap" parameterType="long">
        SELECT
        a.award_id,
        a.award_name,
        a.award_desc,
        a.award_img,
        a.point,
        a.priority,
        a.create_time,
        a.last_edit_time,
        a.enable_status,
        s.shop_id,
        s.shop_name
        FROM tb_award a, tb_shop s
        WHERE
        a.shop_id = s.shop_id
        AND
        a.award_id = #{awardId}
    </select>

    <!-- 添加奖品 -->
    <insert id="insertAward" useGeneratedKeys="true"
            keyColumn="award_id" keyProperty="awardId">
        INSERT INTO tb_award(award_name, award_desc, award_img, point, priority,
         create_time, last_edit_time, enable_status, shop_id) VALUES
            (#{awardName},#{awardDesc},#{awardImg},#{point},
             #{priority},#{createTime},#{lastEditTime},#{enableStatus},#{shop.shopId})
    </insert>

    <update id="updateAward" parameterType="com.al.o2o.entity.Award">
        UPDATE tb_award
        <set>
            <if test="awardName!=null">award_name=#{awardName},</if>
            <if test="awardDesc!=null">award_desc=#{awardDesc},</if>
            <if test="awardImg!=null">award_img=#{awardImg},</if>
            <if test="point!=null">point=#{point},</if>
            <if test="priority!=null">priority=#{priority},</if>
            <if test="lastEditTime!=null">last_edit_time=#{lastEditTime},</if>
            <if test="enableStatus!=null">enable_status=#{enableStatus},</if>
            <if test="shop!=null">shop_id=#{shopId}</if>
        </set>
        WHERE award_id=#{awardId}
    </update>

    <!-- 下架奖品 -->
    <delete id="deleteAward">
		DELETE FROM
		tb_award
		WHERE
		award_id = #{awardId}
		AND
		shop_id=#{shopId}
	</delete>
</mapper>